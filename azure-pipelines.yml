trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'windows-latest'

variables:
  azureSubscription: 'AzureConnection-UAMI'
  functionAppName: 'iothubandroid'
  resourceGroup: 'iothost'
  buildConfig: 'Release'

steps:
- task: UseDotNet@2
  displayName: 'Install .NET 8.0 SDK'
  inputs:
    packageType: 'sdk'
    version: '8.0.x'

- task: DotNetCoreCLI@2
  displayName: 'Restore packages'
  inputs:
    command: 'restore'
    projects: '**/*.csproj'

- task: DotNetCoreCLI@2
  displayName: 'Build project'
  inputs:
    command: 'build'
    projects: '**/*.csproj'
    arguments: '--configuration $(buildConfig) --no-restore'

- task: DotNetCoreCLI@2
  displayName: 'Publish project'
  inputs:
    command: 'publish'
    publishWebProjects: false
    projects: '**/*.csproj'
    arguments: '--configuration $(buildConfig) --output $(Build.ArtifactStagingDirectory)/output --no-build'
    zipAfterPublish: true
    modifyOutputPath: false

# Usar la tarea oficial AzureFunctionApp@2 con configuración específica para .NET 8
- task: AzureFunctionApp@2
  displayName: 'Deploy Azure Function App v2'
  inputs:
    # Configuración básica
    connectedServiceNameARM: '$(azureSubscription)'
    appType: 'functionApp'  # Windows Function App
    appName: '$(functionAppName)'
    package: '$(Build.ArtifactStagingDirectory)/output/**/*.zip'
    
    # Configuración específica para .NET 8 isolated
    runtimeStack: 'DOTNET-ISOLATED|8.0'  # Específico para .NET 8 isolated
    
    # Configuración de aplicación optimizada para .NET 8 isolated
    appSettings: |
      -FUNCTIONS_EXTENSION_VERSION ~4
      -FUNCTIONS_WORKER_RUNTIME dotnet-isolated
      -WEBSITE_RUN_FROM_PACKAGE 0
      -SCM_DO_BUILD_DURING_DEPLOYMENT false
    
    # Método de deployment específico
    deploymentMethod: 'zipDeploy'  # Explícitamente usar zipDeploy
