trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'windows-latest'

variables:
  azureSubscription: 'AzureConnection-UAMI'  # Nombre de la conexión de servicio de Azure
  functionAppName: 'iothubandroid'  # Nombre de tu Function App
  resourceGroup: 'iothost'  # Grupo de recursos de tu Function App
  buildConfig: 'Release'
  outputDir: '$(Build.ArtifactStagingDirectory)/publish_output'
  zipPath: '$(Build.ArtifactStagingDirectory)/app.zip'

steps:
- task: UseDotNet@2
  inputs:
    packageType: 'sdk'
    version: '8.0.x'  # Asegura que se use el SDK .NET 8.0 para la compilación

- task: DotNetCoreCLI@2
  inputs:
    command: 'restore'
    projects: '**/*.csproj'

- task: DotNetCoreCLI@2
  inputs:
    command: 'build'
    projects: '**/*.csproj'
    arguments: '--configuration $(buildConfig)'

- task: DotNetCoreCLI@2
  inputs:
    command: 'publish'
    publishWebProjects: false
    projects: '**/*.csproj'
    arguments: '--configuration $(buildConfig) --output $(outputDir)'
    zipAfterPublish: false
    modifyOutputPath: false

- task: PowerShell@2
  displayName: 'Verificar la estructura de carpetas después de la compilación'
  inputs:
    targetType: 'inline'
    script: |
      $buildOutputDir = "$(Build.ArtifactStagingDirectory)/publish_output"
      Write-Host "Contenido del directorio de salida de la compilación:"
      Get-ChildItem -Recurse -Path $buildOutputDir | ForEach-Object {
          Write-Host $_.FullName
      }

      $functionDirs = Get-ChildItem -Path $buildOutputDir -Recurse | Where-Object { $_.PSIsContainer -eq $true -and ($_.Name -like "MyFunction*" -or $_.Name -like "HttpTrigger*") }
      if ($functionDirs.Count -eq 0) {
          Write-Host "No se encontraron carpetas de función."
          throw "Faltan las carpetas de función necesarias."
      }

      $functionJsonFiles = Get-ChildItem -Path $buildOutputDir -Recurse | Where-Object { $_.Name -eq "function.json" }
      if ($functionJsonFiles.Count -eq 0) {
          Write-Host "No se encontraron archivos function.json."
          throw "Faltan archivos function.json necesarios para las funciones."
      }

- task: ArchiveFiles@2
  displayName: 'Archivar los archivos publicados en un archivo ZIP'
  inputs:
    rootFolderOrFile: '$(outputDir)'
    includeRootFolder: false
    archiveType: 'zip'
    archiveFile: '$(zipPath)'
    replaceExistingArchive: true

- task: PowerShell@2
  displayName: 'Verificar contenido del archivo ZIP antes del despliegue'
  inputs:
    targetType: 'inline'
    script: |
      $zipPath = "$(Build.ArtifactStagingDirectory)/app.zip"
      if (Test-Path $zipPath) {
          Write-Host "Archivo ZIP encontrado: $zipPath"
          $sizeMB = [Math]::Round((Get-Item $zipPath).Length / 1MB, 2)
          Write-Host "Tamaño del ZIP: $sizeMB MB"
          Write-Host "Contenido del archivo ZIP:"
          Add-Type -AssemblyName System.IO.Compression.FileSystem
          [System.IO.Compression.ZipFile]::OpenRead($zipPath).Entries | ForEach-Object {
              Write-Host " - $($_.FullName)"
          }
      } else {
          Write-Host "Archivo ZIP no encontrado en $zipPath"
          throw "El archivo ZIP para despliegue no existe."
      }

- task: AzureCLI@2
  displayName: 'Listar y detener la Function App destino'
  inputs:
    azureSubscription: '$(azureSubscription)'
    scriptType: 'ps'
    scriptLocation: 'inlineScript'
    inlineScript: |
      Write-Host "Listando todas las Function Apps en el grupo de recursos"
      az functionapp function list --name iothubandroid --resource-group iothost --output table
      Write-Host "Deteniendo la Function App objetivo: $(functionAppName)"
      az functionapp stop --name $(functionAppName) --resource-group $(resourceGroup)

- task: AzureFunctionApp@2
  inputs:
    connectedServiceNameARM: '$(azureSubscription)'
    appType: 'functionApp'
    isFlexConsumption: true
    appName: '$(functionAppName)'
    package: '$(Build.ArtifactStagingDirectory)/app.zip'
    deploymentMethod: auto

- task: AzureCLI@2
  displayName: 'Iniciar la Function App'
  inputs:
    azureSubscription: '$(azureSubscription)'
    scriptType: 'ps'
    scriptLocation: 'inlineScript'
    inlineScript: |
      Write-Host "Iniciando la Function App objetivo: $(functionAppName)..."
      az functionapp start --name $(functionAppName) --resource-group $(resourceGroup)