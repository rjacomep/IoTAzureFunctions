trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'windows-latest'

variables:
  azureSubscription: 'AzureConnection-AgentAssigned'  # Your service connection name
  functionAppName: 'iothubandroid'                   # Your Azure Function App name
  buildConfig: 'Release'
  outputDir: '$(Build.ArtifactStagingDirectory)/publish_output'
  zipPath: '$(Build.ArtifactStagingDirectory)/app.zip'

steps:
- task: UseDotNet@2
  inputs:
    packageType: 'sdk'
    version: '8.0.x'  # This ensures the .NET SDK 8.0 is used for your build

- script: |
    dotnet publish --configuration $(buildConfig) --framework net8.0 --output $(outputDir)
    powershell -Command "Compress-Archive -Path $(outputDir)\* -DestinationPath $(zipPath)"
  displayName: 'Publish and Zip .NET 8.0 Isolated Function'

- task: AzureFunctionApp@2
  displayName: 'Deploy .NET Isolated Azure Function'
  inputs:
    azureSubscription: $(azureSubscription)
    appType: functionApp
    appName: $(functionAppName)
    package: $(zipPath)
    runtimeStack: 'DOTNET-ISOLATED|8.0'  # This is crucial for isolated .NET 8.0 functions